//@version=6
// EMA Bounce â€¢ VWAP + MACD â€¢ Multi-Symbol/TF Alerts + Host-Chart R:R Drawings
// Create ONE TradingView alert with: Condition â†’ "Any alert() function call", Options â†’ "Once per bar close"

indicator("EMABounce + VWAP + MACD â€¢ Multi-Asset Alerts (with Host R:R Drawings)", overlay=true, calc_on_every_tick=false, shorttitle="EMABnc v6 â€¢ Multi + Draw")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Inputs (same as your single-symbol script) â”€â”€â”€â”€â”€â”€â”€â”€â”€
fastLen     = input.int(9,   "EMA 9 (Fast)",    minval=1)
medLen      = input.int(20,  "EMA 20 (Medium)", minval=1)
slowLen     = input.int(200, "EMA 200 (Slow)",  minval=1)

macdFast    = input.int(12,  "MACD Fast")
macdSlow    = input.int(26,  "MACD Slow")
macdSig     = input.int(9,   "MACD Signal")

tolPct      = input.float(0.05, "Bounce tolerance % below EMA-9", step=0.01)
maxWait     = input.int(30,  "Max bars to wait for bounce (0 = unlimited)")

// 3:1 R:R drawing controls for HOST chart only
rrMultiple    = input.float(3.0, "R:R Multiple (e.g., 3 for 3:1)", step=0.25)
rrHorizonBars = input.int(40,    "R:R Guide Length (bars)", minval=5, maxval=500)
showBoxes     = input.bool(true, "Shade Risk (1R) and Reward (R:R) Areas")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Universe (4 symbols Ã— 4 timeframes) â”€â”€â”€â”€â”€â”€â”€â”€â”€
var string[] SYMS = array.from(
    "BINANCE:BTCUSDT",
    "BINANCE:ETHUSDT",
    "BINANCE:ETHBTC",
    "BINANCE:ADAUSDT"
)
var string[] TFS  = array.from("15", "60", "240", "D")  // 15m, 1h, 4h, 1D

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Signal block (runs inside each security context) â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mirrors your logic; window approximated via barssince(cross) â‰¤ maxWait while bull stack holds.
// Returns: [hit(bool), entry(float), stop(float), target(float), barTime(int)]
signalBlock(float tolP, int mWait, float rr) =>
    ema9   = ta.ema(close, fastLen)
    ema20  = ta.ema(close, medLen)
    ema200 = ta.ema(close, slowLen)
    vwap   = ta.vwap(hlc3)
    [macdLine, signalLine, _] = ta.macd(close, macdFast, macdSlow, macdSig)

    bullStack  = ema9 > ema20 and ema20 > ema200
    emaCrossUp = ta.crossover(ema9, ema20) and ema9 > ema200

    tolPrice = ema9 * (1 + tolP / 100.0)
    bounce   = low <= tolPrice and close > ema9

    priceAboveVWAP = close > vwap
    macdBull       = macdLine > signalLine

    cb    = ta.barssince(emaCrossUp)             // -1 if never
    soon  = (cb == 0) or (cb >= 0 and (mWait == 0 or cb <= mWait))
    armed = soon and bullStack

    hit = armed and bounce and priceAboveVWAP and macdBull and barstate.isconfirmed

    entry  = na
    stop   = na
    target = na
    if hit
        entry := close
        stop  := low
        risk  = entry - stop
        target := risk > 0 ? entry + rr * risk : na

    [hit, entry, stop, target, time]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Host-chart drawing state (only used when host combo triggers) â”€â”€â”€â”€â”€â”€â”€â”€â”€
var line  slLine  = na
var line  enLine  = na
var line  tpLine  = na
var label slLbl   = na
var label enLbl   = na
var label tpLbl   = na
var box   riskBox = na
var box   rewBox  = na

// For a small on-chart heads-up of the latest fired payload (any combo)
var label latestLbl = na

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Iterate all combos; alert all; draw when host symbol & TF match â”€â”€â”€â”€â”€â”€â”€â”€â”€
for i = 0 to array.size(SYMS) - 1
    sym = array.get(SYMS, i)
    for j = 0 to array.size(TFS) - 1
        tf = array.get(TFS, j)

        [hit, e, s, t, tstamp] = request.security(sym, tf, signalBlock(tolPct, maxWait, rrMultiple),
            barmerge.gaps_off, barmerge.lookahead_off)

        if hit and not na(e) and not na(s) and not na(t)
            cleanSym = str.replace(sym, "BINANCE:", "")
            payload = str.format(
              "{{\"event\":\"EMA_BOUNCE_BUY\",\"symbol\":\"{0}\",\"timeframe\":\"{1}\",\"bar_time\":{2},\"entry\":{3},\"stop\":{4},\"target\":{5},\"rr\":{6},\"signal_id\":\"{7}_{8}_{9}\"}}",
              cleanSym, tf, tstamp, e, s, t, rrMultiple, cleanSym, tf, str.tostring(tstamp))

            // Emit JSON for your single TradingView alert (â€œAny alert() function callâ€)
            alert(payload, alert.freq_once_per_bar_close)

            // Update a small floating label with the latest signal info (host chart display only)
            if barstate.islast
                if not na(latestLbl)
                    label.delete(latestLbl)
                latestLbl := label.new(bar_index, high, 
                    str.format("Last Signal â†’ {0} {1}\nEntry: {2} | SL: {3} | TP({4}R): {5}", cleanSym, tf, e, s, rrMultiple, t),
                    style=label.style_label_down, textcolor=color.white, color=color.new(color.blue, 0), size=size.small)

            // If this hit is for the HOST chart symbol & timeframe, draw 3:1 R:R lines/labels/boxes
            if (sym == syminfo.tickerid) and (tf == timeframe.period)
                risk = e - s
                if risk > 0
                    // Clean previous set so chart stays tidy
                    line.delete(slLine)
                    line.delete(enLine)
                    line.delete(tpLine)
                    label.delete(slLbl)
                    label.delete(enLbl)
                    label.delete(tpLbl)
                    box.delete(riskBox)
                    box.delete(rewBox)

                    x1 = bar_index
                    x2 = bar_index + rrHorizonBars

                    slLine := line.new(x1, s,   x2, s,   xloc=xloc.bar_index, extend=extend.none, color=color.new(color.red,   0), width=2)
                    enLine := line.new(x1, e,   x2, e,   xloc=xloc.bar_index, extend=extend.none, color=color.new(color.white, 0), width=2)
                    tpLine := line.new(x1, t,   x2, t,   xloc=xloc.bar_index, extend=extend.none, color=color.new(color.lime,  0), width=2)

                    slLbl := label.new(x2, s,   text="SL",        style=label.style_label_left, textcolor=color.white, color=color.red)
                    enLbl := label.new(x2, e,   text="Entry",     style=label.style_label_left, textcolor=color.black, color=color.white)
                    tpLbl := label.new(x2, t,   text=str.tostring(rrMultiple, "#.##") + "R TP", style=label.style_label_left, textcolor=color.white, color=color.lime)

                    if showBoxes
                        riskBox := box.new(x1, e, x2, s, xloc=xloc.bar_index, bgcolor=color.new(color.red, 85),  border_color=color.new(color.red, 0))
                        rewBox  := box.new(x1, t, x2, e, xloc=xloc.bar_index, bgcolor=color.new(color.lime, 85), border_color=color.new(color.lime, 0))

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ Optional: host-chart status table â”€â”€â”€â”€â”€â”€â”€â”€â”€
showStatus = input.bool(true, "Show status table (host chart only)")
if showStatus and barstate.islast
    var table status = na
    if not na(status)
        table.delete(status)
    status := table.new(position.top_right, 2, 6, bgcolor=color.new(color.blue, 90), border_width=1)
    table.cell(status, 0, 0, "ðŸŽ¯ MONITORING", text_color=color.white, bgcolor=color.blue)
    table.cell(status, 1, 0, "STATUS",        text_color=color.white, bgcolor=color.blue)
    table.cell(status, 0, 1, "BTCUSDT", text_color=color.yellow)
    table.cell(status, 1, 1, "15mâ€¢1hâ€¢4hâ€¢1D",  text_color=color.white)
    table.cell(status, 0, 2, "ETHUSDT", text_color=color.yellow)
    table.cell(status, 1, 2, "15mâ€¢1hâ€¢4hâ€¢1D",  text_color=color.white)
    table.cell(status, 0, 3, "ETHBTC",  text_color=color.yellow)
    table.cell(status, 1, 3, "15mâ€¢1hâ€¢4hâ€¢1D",  text_color=color.white)
    table.cell(status, 0, 4, "ADAUSDT", text_color=color.yellow)
    table.cell(status, 1, 4, "15mâ€¢1hâ€¢4hâ€¢1D",  text_color=color.white)
    table.cell(status, 0, 5, "TOTAL",    text_color=color.orange)
    table.cell(status, 1, 5, "16 combos", text_color=color.orange)