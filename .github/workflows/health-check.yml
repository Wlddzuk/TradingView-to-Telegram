name: System Health Check

on:
  schedule:
    # Run every 5 minutes for health monitoring
    - cron: '*/5 * * * *'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Main App Health
        run: |
          echo "ðŸ¥ Checking main application health..."
          
          response=$(curl -s -w "\n%{http_code}" \
            "https://walid3rbot-git-main-walids-projects-fd231c7c.vercel.app/")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "ðŸ“¡ Main App HTTP Status: $http_code"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Main application is healthy"
          else
            echo "âŒ Main application health check failed"
            echo "$body"
            exit 1
          fi
          
      - name: Check Email Endpoint Health  
        run: |
          echo "ðŸ“§ Checking email processing endpoint..."
          
          response=$(curl -s -w "\n%{http_code}" \
            "https://walid3rbot-git-main-walids-projects-fd231c7c.vercel.app/api/email_check")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "ðŸ“¡ Email Endpoint HTTP Status: $http_code"
          
          if [ "$http_code" -eq 200 ]; then
            if echo "$body" | grep -q '"status":"ok"'; then
              echo "âœ… Email processing endpoint is healthy"
            else
              echo "âš ï¸ Email endpoint responded but may have issues"
              echo "$body"
            fi
          else
            echo "âŒ Email endpoint health check failed"  
            echo "$body"
            exit 1
          fi
          
      - name: Environment Check
        run: |
          echo "ðŸ”§ Environment Information:"
          echo "ðŸ“… UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸŒ Runner Location: GitHub Actions"
          echo "ðŸ–¥ï¸ OS: $(uname -s)"
          echo "ðŸ’¾ Available Memory: $(free -h | grep '^Mem:' | awk '{print $7}' || echo 'N/A')"
          echo "âš¡ Network Test: $(ping -c 1 google.com > /dev/null && echo 'OK' || echo 'FAILED')"